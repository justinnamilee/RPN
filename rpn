#!/usr/bin/perl

# By: Justin Lee
# Date: QUANRANTINE 2020
#
# Description:
#   Yo dawg, this is an RPN calculator.
#   It does that kind of thing, you
#   know?

use lib q[.];
use strict;

#use RPN; # import the machine


  ######
  #   main::Loader
   #    Terminal IO?

# commands queue
my @command = @ARGV;

# config settings
my %config =
(
	# storage
	calculator  => q[./data/Calculator.rpn],
	computer    => q[./data/Computer.rpn],
	# reverse file input? (mem/rpn mode)
	reverse     => RPN::Constant->DEF_AUTO_REVERSE,
	# you want to talk to me?
	interactive => RPN::Constant->DEF_INTERACTIVE,
	# extra bidilies
	help        => q[.help]
);

# init the RPN calculator
RPN->prime;

# parse the input, load files as encountered
for (my $i = 0; $config{interactive} || $i < @command; (!$config{interactive}) && $i++)
{
	my $input = $command[$i];

	if ($config{interactive})
	{
		print q[ ~ ];
		chomp($input = <STDIN>);
	}

	# if we're given files stack their input onto the queue
	if (-f $input)
	{
		if (open(my $fh, q[<], $input))
		{
			my (@c) = ();

			# line parse time
			while (<$fh>)
			{
				chomp;

				s/#.*//; # no comment
				s/^\s+//;
				s/\s+$//;

				if (/^%/ || -f)
				{
					push(@c, $_);
				}
				else
				{
					push(@c, split);
				}
			}

			# excuse me, pardon me; em nodrap, em esucxe?
			splice(@command, $i+1, 0, ($config{reverse} ? reverse(@c) : @c));
		}
		else
		{
			# TODO: add 'ask to continue mode'
			warn qq[Skipping file '$input': $!];
		}
	}
	elsif ($input =~ /^%\s*(.+?)\s*(?:=>\s*(.+))?$/)
	{
		my ($key, $val) = ($1, $2);

		$config{$key} = $val if (defined($val));

		print qq[config:$key> $config{$key}\n];
	}
	else
	{
		RPN::execute($input);
	}
}


exit 0;
